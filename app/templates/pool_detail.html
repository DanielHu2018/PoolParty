{% extends 'base.html' %}
{% block content %}
  <div class="card">
    <div class="card-body">
      <div style="display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;">
        <div style="flex:1;min-width:320px;">
          <div class="card-title">{{ pool.title }}</div>
          <div class="card-route">{{ pool.origin }} → {{ pool.destination }} {% if pool.depart_time %}• {{ pool.depart_time.strftime('%Y-%m-%d %H:%M') }}{% endif %}</div>
          <div class="card-desc" style="margin-top:10px;">{{ pool.description or "No description provided." }}</div>

          <div style="margin-top:14px;">
            <strong>Riders</strong>
            <ul>
              {% if pool.rides.count() > 0 %}
                {% for r in pool.rides %}
                  <li>{{ r.passenger.username }} {% if r.status != 'cancelled' %} — {{ r.status }}{% else %} — <em>cancelled</em>{% endif %}</li>
                {% endfor %}
              {% else %}
                <li class="muted">No riders yet.</li>
              {% endif %}
            </ul>
          </div>
        </div>

        <aside style="width:300px;">
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div>
              <div class="pill">Seats: {{ seats_available if seats_available is not none else pool.seats }}</div>
            </div>
            <div>
              <div class="muted">Driver</div>
              <div><strong>{{ pool.owner.username }}</strong><br><span class="muted">{{ pool.owner.email }}</span></div>
            </div>

            <div>
              {% if not current_user.is_authenticated %}
                <a href="{{ url_for('auth.login') }}" class="btn">Log in to request</a>
              {% else %}
                {% if is_owner %}
                  <div class="muted">You created this pool. You are included by default.</div>
                  <form method="post" action="{{ url_for('main.cancel_pool', pool_id=pool.id) }}">
                    <button type="submit" class="btn secondary">Cancel Pool</button>
                  </form>
                {% else %}
                  {% if is_rider %}
                    <div class="muted">You are participating in this pool.</div>
                    <form method="post" action="{{ url_for('main.leave_pool', pool_id=pool.id) }}">
                      <button type="submit" class="btn secondary">Leave Pool</button>
                    </form>
                  {% else %}
                    {% if is_full %}
                      <div class="muted">This pool is full.</div>
                    {% else %}
                      <div style="margin-top:6px;">
                        <form method="post">
                          {{ form.hidden_tag() }}
                          <div class="form-group">
                            {{ form.message(rows=3, placeholder='Optional message to the driver') }}
                          </div>
                          <div class="form-actions">
                            {{ form.submit(class="btn") }}
                          </div>
                        </form>
                      </div>
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>
{% endblock %}
