{% extends 'base.html' %}
{% block content %}
  <h2>Manage</h2>
  <h3>Your pools</h3>
  {% if owned_pools %}
    <ul>
    {% for p in owned_pools %}
      <li>
        <strong>{{ p.title }}</strong> — <a href="{{ url_for('main.pool_detail', pool_id=p.id) }}">view</a>
        <div style="margin-top:8px;">
          <em>Riders:</em>
          <ul>
            {% for r in p.rides %}
              <li>{{ r.passenger.username }} {% if r.status != 'cancelled' %} — {{ r.status }}{% else %} — <em>cancelled</em>{% endif %}
                <form method="post" action="{{ url_for('main.remove_rider', pool_id=p.id, user_id=r.user_id) }}" style="display:inline;margin-left:8px;">
                  <button type="submit" class="btn secondary">Remove</button>
                </form>
              </li>
            {% else %}
              <li class="muted">No riders yet.</li>
            {% endfor %}
          </ul>
          <form method="post" action="{{ url_for('main.add_rider', pool_id=p.id) }}" style="margin-top:6px;">
            <input name="identifier" placeholder="username or email" class="search-input" style="width:220px;display:inline-block;"> 
            <button type="submit" class="btn">Add rider</button>
          </form>
        </div>
      </li>
    {% endfor %}
    </ul>
  {% else %}
    <p>You do not own any pools.</p>
  {% endif %}

  <h3>Requests for your pools</h3>
  {% if owner_requests %}
    {% set current_pool = None %}
    <ul>
    {% for jr in owner_requests %}
      {% if not loop.first and jr.pool.id != current_pool %}
        {# just continue grouping #}
      {% endif %}
      {% set current_pool = jr.pool.id %}
      <li>
        <strong>{{ jr.pool.title }}</strong> — {{ jr.requester.username }}: {{ jr.status }}
        {% if jr.status == 'pending' %}
          — <a href="{{ url_for('main.handle_request', req_id=jr.id, action='accept') }}">accept</a> | <a href="{{ url_for('main.handle_request', req_id=jr.id, action='reject') }}">reject</a>
        {% else %}
          {% if jr.status == 'accepted' %}
            — <em>accepted</em>
          {% else %}
            — <em>{{ jr.status }}</em>
          {% endif %}
        {% endif %}
      </li>
    {% endfor %}
    </ul>
  {% else %}
    <p>No incoming requests for your pools.</p>
  {% endif %}

  <h3>Pools you're riding in</h3>
  {% if my_rides %}
    <ul>
    {% for ride in my_rides %}
      <li>
        <strong>{{ ride.pool.title }}</strong> — {{ ride.pool.origin }} → {{ ride.pool.destination }} — <a href="{{ url_for('main.pool_detail', pool_id=ride.pool.id) }}">view</a>
        <form method="post" action="{{ url_for('main.leave_pool', pool_id=ride.pool.id) }}" style="display:inline;margin-left:8px;">
          <button type="submit" class="btn secondary">Leave</button>
        </form>
      </li>
    {% endfor %}
    </ul>
  {% else %}
    <p>You are not riding in any pools.</p>
  {% endif %}

  <h3>Your join requests</h3>
  {% if my_requests %}
    <ul>
    {% for r in my_requests %}
      <li>{{ r.pool.title }} — {{ r.status }}</li>
    {% endfor %}
    </ul>
  {% else %}
    <p>No requests.</p>
  {% endif %}
{% endblock %}
